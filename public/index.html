<html>
<head>
    <meta charset="UTF-8">
    <title>Offline Web</title>
 <style>
  .support {
    display: none;
  }
</style>
</head>
<body>

    <h1>Offline web demo!</h1>

    <div class="support serviceworker missing">
    Service worker is not supported on your browser.
    </div>
    <div class="support serviceworker default">
    Service worker is supported on your browser.
    </div>

    <form id="eventForm">
        <label>
            Event name:
            <input type="text" name="event[name]" id="event_name" />
        </label>
        <label>
            Event description:
            <input type="text" name="event[description]" id="event_description" />
        </label>
        <input type="submit" />
    </form>

    <ul id="eventList">
    </ul>

</body>
<script src="vendor/es6-promise.js"></script>
<script src="vendor/EventSource.js"></script>
<script src="vendor/jquery-1.11.3.js"></script>
<script src="vendor/handlebars-v4.0.2.js"></script>
<script src="js/dataCollection.js"></script>
<script id="itemTemplate" type="text/x-handlebars-template">
<li id='item-{{id}}'>
  {{name}}: {{createdAt}}
  <button>Delete me</button>
</li>
</script>
<script>
/* globals appDataCollection, Collection, $, EventSource, Handlebars */
/* exported saveEvent */
var talks;

function postJSON(url, json) {
  return $.ajax({
    method: 'post',
    url: url,
    contentType: 'application/json',
    data: JSON.stringify(json)
  });
}

function setApiSupport(api, supportLevel) {
  $(".support." + api).hide();
  $(".support." + api + "." + supportLevel).show();
}

function transmit() {
  talks.transmitToServer(function(item) {
    return postJSON('/talks', item);
  }).fail(function() {
    console.log('Failed', e);
    setTimeout(transmit, 10000);
  });
}

function transmitToServer() {
    talks.list('by_transmittedAt', 'never').then(function(items) {
        items.forEach(function(talk) {
            postJSON('/talks', talk).fail(function(jqXHR, textStatus, e) {
              console.log('Failed', e);
              setTimeout(transmitToServer, 10000);
            }).then(function() {
              talk.transmittedAt = new Date();
              return talks.save(talk);
            });
        });
    });
}

$(function() {
  'use strict';

  var itemTemplate = Handlebars.compile($('#itemTemplate').html());

  if ('serviceWorker' in navigator) {
    setApiSupport("serviceWorker", "default");

    navigator.serviceWorker.register('serviceworker.js').then(function(registration) {
        console.log('service worker ok ', registration);
    }).catch(function(err) {
        console.error('service worker registration failed', err);
    });
  } else {
    setApiSupport("serviceWorker", "missing");
  }

  appDataCollection.open().then(function(db) {
      talks = new Collection(db, 'talks');

      talks.list('by_createdAt').then(function(events) {
        var eventList = $('#eventList');
        eventList.empty();
        events.forEach(function(e) {
          eventList.append(itemTemplate(e));
        });
      });
      talks.on('change', function(e) {
        if (!$('#item-' + e.id).length) {
          $('#eventList').append(itemTemplate(e));
        } else {
          $('#item-' + e.id).replaceWith(itemTemplate(e));
        }
      })
  });

  $('#eventForm').submit(function(event) {
    event.preventDefault();
    talks.save({
      name: $('#event_name').val(),
      description: $('#event_description').val()
    }).then(function() {
      setTimeout(transmitToServer);
    });
    this.reset();
    return false;
  });

  var talkEvents = new EventSource('/talks/events');
  talkEvents.addEventListener('insert', function(event) {
    talks.save(JSON.parse(event.data));
  });
});
</script>
</html>